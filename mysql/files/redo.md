# 重做日志

## 概念

默认情况下，InnoDB存储引擎的数据目录下会有两个名为ib_logfile0和ib_logfile1的文件。官方文档将其称为其引擎的日志文件，更准确地来说应该是重做日志文件（redo log file）。

每个InnoDB存储引擎至少有1个重做日志组，每个文件组下至少有2个重做日志文件（默认的ib_logfile0和ib_logfile1）。

## 作用

InnoDB存储引擎会使用重做日志恢复到异常关闭前的时刻，保证数据的完整性。

## 影响参数

### 1. innodb_log_file_size

指定重做日志的大小，InnoDB1.2.x版本前，重做日志的大小不得大于等于4G。1.2.x版本将该限制扩大为512G。

### 2. innodb_log_files_in_group

指定了日志文件组中重做日志文件的数量，默认为2。

### 3. innodb_mirrored_log_groups

指定日志镜像文件组的数量，默认为1，表示只有1个日志文件组，没有镜像。

### 4. innodb_log_group_home_dir

指定日志文件组所在路径，默认为`./`

## 与二进制日志的区别

| 区别 | 二进制日志 | 重做日志 |
| :-: | :-: | :-: |
| 记录范围不同 | 记录所有与MYSQL数据库有关的日志记录，包括InnoDB、MyISAM、Heap等其他存储引擎的日志 | 只存储该存储引擎本身的事务日志 |
| 记录目标不同 | 记录的是一个事物具体操作内容，即该日志是逻辑日志 | 记录关于每个页的更改的物理情况 |
| 写入时间不同 | 仅在事务提交前进行提交（只写磁盘一次，无论此时该事务多大） | 事务执行过程中，不断有重做日志条目被写入重做日志中 |

## 重做日志格式

### 小概念

到1.2.x版本，总共定义了51种重做日志格式。

### 重做日志条目格式

| redo_log_type | space | page_no | redo_log_body |

| 字段 | 含义 |
| :-: | :-: |
| redo_log_type | 占用1个字节，表示重做日志的类型 |
| space | 表示表空间的ID，但采用压缩的方式，因此占用的空间可能小于4字节 |
| page_no | 页的偏移量，采用压缩方式 |
| redo_log_body | 每个重做日志的数据部分，恢复时需要调用相应的函数进行解析 |

## 重做日志的写入

写重做日志文件的操作不是直接写，而是先写入一个重做日志缓冲中，再按照一定的条件顺序地写入日志文件。

从重做日志缓冲往磁盘写入时，是按照512字节（一个扇区的大小）进行写入。因为扇区是写入的最小单位，因此可以保证写入必定是成功的。因此重做日志的写入是不需要有doublewrite。
