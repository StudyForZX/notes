# InnoDB逻辑存储结构

## 1. 概念

所有数据都被逻辑地存放在一个空间中，称之为表空间（tablespace）。表空间又由段（segment）、区（extent）、页（page）组成。页有时被称为块（block）。

## 2. 存储结构

表空间存储包含叶子节点段（数据段）、非叶子节点段（索引段）、回滚段。
段存储多个区。
区存储多个页。
页中包含多行数据。
每行数据包含`Trx id`、多个`roll pointer`、`col 1`、...、`col n`

## 3. 表空间

### 3.1 概念

表空间可以看做是InnoDB存储引擎逻辑结构的最高层，所有的数据都存放在表空间中。（如共享表空间ibdata1）

### 3.2 影响参数

innodb_file_per_table，如果启用，需要注意的是每张表的表空间内存放的只是数据、索引和插入缓冲bitmap页，其他类的数据，比如回滚信息，插入缓冲索引页、系统事务信息，二次缓冲写（double writer buffer）等还是放在原来的共享表空间。说明即使启用之后共享表空间还是会不断地增大。

## 4. 段

### 4.1 概念

表空间是由各个段组成的，常见的段有数据段、索引段、回滚段等。

## 5. 区

### 5.1 概念

区是由连续的页组成的空间，在任何情况下每个区的大小都为`1MB`。为了保证区中页的连续性，InnoDB存储引擎一次从磁盘申请`4~5个区`。在默认情况下，InnoDB存储引擎页的大小为`16KB`，即一个区中一共有`64`个连续的页。

### 5.2 影响参数

InnoDB 1.0.x版本引入压缩页，每个页可以通过参数`KET_BLOCK_SIZE`设置为2K、4K、8K，因此每个区对应页的数量就应该为512、256、128。
InnoDB 1.2.x版本新增参数`innodb_page_size`，通过设置参数可以将默认页大小设置为4K、8K，但是页中的数据不是压缩的。

### 5.3 思考问题

在用户启用了参数`innodb_file_per_table`后，创建的表默认大小是96KB。区中是64个连续的页，创建的表大小至少是1MB才对？

答： 实际上在每个段的开始，先用32个页大小的碎片页来存放数据，在使用完这些页之后才是64个连续页的我申请。这样做的目的是对于一些小表，或者undo这类的段，可以在开始时申请较少的空间，节省磁盘容量的开销。

## 6. 页

### 6.1 概念

InnoDB有页（块）的概念，页是磁盘管理的最小单位。该引擎中，默认每个页的大小为16K。

该引擎中，常见的页类型：

1. 数据页
2. undo页
3. 系统页
4. 事务数据页
5. 插入缓冲位图页
6. 插入缓冲空闲列表页
7. 未压缩的二进制大对象页
8. 压缩的二进制大对象页

## 7. 行

### 7.1 概念

InnoDB存储引擎是面向列的，也就是说数据是按行激进行存放的。每个页存放的行记录也是有硬性规定的，最多允许存放`16KB/2 - 200`行的记录，即`7992`行。
