# InnoDB行记录格式

查看当前数据库使用的行记录结构类型

```mysql
SHOW TABLE STATUS LIKE `TABLE_NAME`;
```

## 1. compact行记录格式

`compact`行记录是在`MySQL5.0`引入的，设计目标是高效地存储数据。简单来说。一个页中存放的行记录越多，其性能就越高。

| 变长字段长度列表 | NULL标志位 | 记录头信息 | 列1数据 | 列2数据 |

### 1.1 变长字段

`campact`行记录格式的首部是一个非NULL变长字段长度列表，并且其是按照列的顺序逆序放置的，其长度为：

1. 若列的长度小于`255`字节，用`1`字节表示；
2. 若大于`255`字节，用`2`字节表示。

变长字段的长度最大不可超过2字节，这是因为在MySQL数据库中VARCHAR类型的最大长度限制为`65535`。

### 1.2 NULL标志符

变长字段之后的第二个部分是NUll标志位，该位指示了改行数据中是否有NULL值，有则用`1`表示。该部分所占的字节为`1`字节。

### 1.3 记录头信息

固定占用5字节（40位）

| 名称 | 大小（bit）| 描述 |
| :-: | :-: | :-: |
| () | 1 | 未知 |
| () | 1 | 未知 |
| deleted_flag | 1 | 该行是否已被删除 |
| min_rcc_flag | 1 | 为1，如果该记录是预先被定义为最小的记录 |
| n_owned | 4 | 该行记录拥有的记录数 |
| heap_no | 13 | 索引堆中该条记录的排序记录 |
| record_type | 3 | 记录类型，000表示普通，001表示B+树节点指针，010表示Infimum，011表示Supermum，1xx表示保留 |
| next_record | 16 | 页中下一条记录是的相对位置 |
| Total | 40 | |

1. 最后部分就是实际存储每个列的数据。##`NULL`不占该部分任何空间，即`NULL`除了占有`NULl`标志位，实际存储不占有任何空间。
2. 另外有一点需要注意的是，每行数据除了用户定义的列外，还有两个隐藏列，事务ID列和回滚指针列，分别为`6`字节、`7`字节的大小。
3. 若没有主键，每行还会增加一个`6`字节的`rowid`。

## 2. Redundant行记录格式

`MySQL5.0`版本之前的行记录存储方式。

| 字段长度偏移列表 | 记录头信息 | 列1数据 | 列2数据 | 列3数据 | ... |

### 2.1 变长字段

该行格式首部是一个字段长度偏移列表，以列的顺序逆序放置。

1. 列的长度小于`255`字节，用`1`字节表示；
2. 若大于`255`字节，用`2`字节表示。

### 2.2 记录头信息

占用6字节（48位）。

| 名称 | 大小（bit）| 描述 |
| :-: | :-: | :-: |
| () | 1 | 未知 |
| () | 1 | 未知 |
| deleted_flag | 1 | 该行是否已被删除 |
| min_rcc_flag | 1 | 为1，如果该记录是预先被定义为最小的记录 |
| n_owned | 4 | 该行拥有的记录数 |
| heap_no | 13 | 索引堆中该条记录的索引号 |
| n_fields | 10 | 记录中列的数量 |
| byte_offs_flag | 1 | 偏移列表为1字节还是2字节 |
| next_record | 16 | 页中下一条记录的相对位置 |
| Total | 48 |  |

### 2.3. 行溢出数据

InnoDB存储引擎可以将一条记录中的某些数据存储在真正的数据页面之外。一般认为`BLOB`、`LOB`这类的大对象类型的存储会把数据存放在数据页面之外。但是，这个理解有点偏差，`BLOB`可以不将数据放在溢出页面，而且即便是`VARCHAR`列数据类型，依然有可能被存放为行溢出数据。

## 3. Compressed和Dynamic行记录格式

InnoDB 1.0.x版本开始引入了新的文件格（可以理解为新的页格式），以前支持的`Compact`和`Redundant`格式称为`Antelope`文件格式，新的文件格式成为`Barracuda`文件格式。`Barracuda`文件格式下拥有两种新的行记录格式：`Compressed`和`Dynamic`。

新的两种记录格式对于存放在`BLOB`中的数据采用了完全的行溢出方式，如图所示：

![行溢出示例](https://github.com/StudyForZX/notes/blob/master/mysql/images/producer_architecture.png)

在数据页只存放`20`个字节的指针，实际的数据都存放在`Off Page`中。

`Compressed`行记录格式的另一个功能就是，存储在其中的行数据会以`zlib`的算法进行压缩，因此存放大长度类型的数据能够进行非常有效的存储。
